<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Caixa Inteligente Pro</title>

<style>
body{margin:0;font-family:Arial;background:#121212;color:white}
.container{padding:20px}
input,select{
padding:10px;margin:5px 0;width:100%;
border-radius:6px;border:none}
button{
padding:10px;margin-top:5px;
border:none;border-radius:6px;
cursor:pointer;background:#00ff88;font-weight:bold}
button:hover{opacity:0.8}
.card{
background:#1e1e1e;padding:15px;
margin:10px 0;border-radius:10px}
.hidden{display:none}
.topbar{
background:#000;padding:15px;
display:flex;justify-content:space-between;align-items:center}
.dashboard{
display:flex;gap:15px;flex-wrap:wrap}
.box{
background:#1e1e1e;padding:20px;
border-radius:10px;flex:1;
min-width:150px;text-align:center}
hr{margin:30px 0}
</style>
</head>
<body>

<div id="authSection" class="container">
<h2>ğŸ” Login</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="senha" placeholder="Senha">
<button onclick="login()">Entrar</button>
<button onclick="registrar()">Criar Conta</button>
</div>

<div id="appSection" class="hidden">

<div class="topbar">
<h2>ğŸ’° Caixa Inteligente Pro</h2>
<button onclick="logout()">Sair</button>
</div>

<div class="container">

<h3>ğŸ“Š Dashboard</h3>
<div class="dashboard">
<div class="box"><h4>Produtos</h4><p id="totalProdutos">0</p></div>
<div class="box"><h4>Faturamento</h4><p id="faturamento">R$ 0</p></div>
<div class="box"><h4>Lucro Bruto</h4><p id="lucroBruto">R$ 0</p></div>
</div>

<hr>

<h3>ğŸ“¦ Cadastrar Produto</h3>
<input type="text" id="nomeProduto" placeholder="Nome">
<input type="number" id="precoProduto" placeholder="PreÃ§o">
<input type="number" id="custoProduto" placeholder="Custo">
<input type="number" id="estoqueProduto" placeholder="Estoque Inicial">
<button onclick="salvarProduto()">Salvar Produto</button>

<div id="listaProdutos"></div>

<hr>

<h3>ğŸ’° Registrar Venda</h3>
<select id="produtoVenda"></select>
<input type="number" id="quantidadeVenda" placeholder="Quantidade">
<select id="pagamentoVenda">
<option value="Pix">Pix</option>
<option value="Dinheiro">Dinheiro</option>
<option value="CartÃ£o">CartÃ£o</option>
</select>
<button onclick="registrarVenda()">Registrar Venda</button>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, query, where }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCeZGx81bH8fe0XimE_1Gu4agejGPzWQ8A",
  authDomain: "caixa-inteligente-f2d23.firebaseapp.com",
  projectId: "caixa-inteligente-f2d23",
  storageBucket: "caixa-inteligente-f2d23.firebasestorage.app",
  messagingSenderId: "685162507832",
  appId: "1:685162507832:web:716647160f381d96d8c0cd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let usuarioAtual=null;

onAuthStateChanged(auth,(user)=>{
if(user){
usuarioAtual=user;
authSection.classList.add("hidden");
appSection.classList.remove("hidden");
carregarTudo();
}else{
authSection.classList.remove("hidden");
appSection.classList.add("hidden");
}
});

window.registrar=async()=>{
await createUserWithEmailAndPassword(auth,email.value,senha.value);
}

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,senha.value);
}

window.logout=async()=>{await signOut(auth);}

async function salvarProduto(){
await addDoc(collection(db,"produtos"),{
nome:nomeProduto.value,
preco:parseFloat(precoProduto.value),
custo:parseFloat(custoProduto.value),
estoque:parseInt(estoqueProduto.value),
uid:usuarioAtual.uid
});
carregarTudo();
}

async function registrarVenda(){
const id=produtoVenda.value;
const qtd=parseInt(quantidadeVenda.value);

const q=query(collection(db,"produtos"),where("__name__","==",id));
const snapshot=await getDocs(q);

snapshot.forEach(async(d)=>{
let produto=d.data();
if(produto.estoque<qtd)return alert("Sem estoque suficiente");

await updateDoc(doc(db,"produtos",id),{
estoque:produto.estoque-qtd
});

await addDoc(collection(db,"vendas"),{
valor:produto.preco*qtd,
lucro:(produto.preco-produto.custo)*qtd,
pagamento:pagamentoVenda.value,
uid:usuarioAtual.uid
});

carregarTudo();
});
}

async function carregarTudo(){
carregarProdutos();
carregarDashboard();
}

async function carregarProdutos(){
listaProdutos.innerHTML="";
produtoVenda.innerHTML="";
let total=0;

const q=query(collection(db,"produtos"),where("uid","==",usuarioAtual.uid));
const snapshot=await getDocs(q);

snapshot.forEach(docSnap=>{
const p=docSnap.data();
const id=docSnap.id;
total++;

listaProdutos.innerHTML+=`
<div class="card">
<strong>${p.nome}</strong><br>
PreÃ§o: R$ ${p.preco}<br>
Custo: R$ ${p.custo}<br>
Estoque: ${p.estoque}
</div>`;

produtoVenda.innerHTML+=`<option value="${id}">${p.nome}</option>`;
});

totalProdutos.innerText=total;
}

async function carregarDashboard(){
let faturamento=0;
let lucro=0;

const q=query(collection(db,"vendas"),where("uid","==",usuarioAtual.uid));
const snapshot=await getDocs(q);

snapshot.forEach(docSnap=>{
const v=docSnap.data();
faturamento+=v.valor;
lucro+=v.lucro;
});

faturamento.innerText="R$ "+faturamento.toFixed(2);
lucroBruto.innerText="R$ "+lucro.toFixed(2);
}

</script>
</body>
</html>
